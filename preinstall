#!/usr/bin/env node

var fs = require('fs')

var cp = require('child_process')

var Download = require('download')
var progress = require('download-status')


// Dependencies versions

const GENEXT2FS_VERSION = "1.4.1"


// Dependencies URLs

const GENEXT2FS_URL="https://github.com/5paceManSpiff/genext2fs/archive/nodeos-"+GENEXT2FS_VERSION+".tar.gz"


//
// genext2fs
//

const SRC_DIR='deps/genext2fs'

fs.exists(SRC_DIR, function(exists)
{
  if(exists) return

  process.stdout.write('Downloading genext2fs... ')

  var download = Download({ extract: true, strip: 1 }).get(GENEXT2FS_URL, SRC_DIR)

  if(!process.env.CI) download.use(progress())

  download.run(function(error)
  {
    if(error) throw error;

    console.log('Done')

    var options = {cwd: SRC_DIR}

    cp.execFile('./autogen.sh', options, function(error)
    {
      if(error) throw error;

      cp.execFile('./configure', options, function(error)
      {
        if(error) throw error;

        cp.exec('make', options, function(error)
        {
          if(error) throw error;

          console.log("Successfully compiled genext2fs")
        })
      })
    })
  })
})
