#!/usr/bin/env bash

# This script prepares the users filesystem

GRN="\e[32m"
CLR="\e[0m"


BAREBONES=`pwd`/../nodeos-barebones
NODE_DIR=$BAREBONES/deps/node

TOOLCHAIN=$BAREBONES/node_modules/nodeos-cross-toolchain
TOOLS=$TOOLCHAIN/out

source $TOOLCHAIN/scripts/adjustEnvVars.sh || exit $?


if [[ -z "$name" ]]; then name=usersfs; fi


if [[ -d $OBJECTS ]]; then
  chmod -R u+w $OBJECTS &&
  rm    -rf    $OBJECTS || exit 10
fi


#
# root home
#

HOME=$OBJECTS/root

mkdir -p $HOME || exit 20


#
# Install system dependencies
#

CC=$TARGET-gcc                  \
CXX=$TARGET-g++                 \
npm_config_prefix=$HOME         \
$NODE_DIR/deps/npm/cli.js       \
    install -g                  \
    --loglevel warn             \
    --arch=$NODE_ARCH           \
    --nodedir=$NODE_DIR         \
    --jobs=$JOBS                \
    `grep -v "^#" packages_root.txt` || exit 21


#
# Services to be started at boot
#

mkdir -p $HOME/etc                 &&
cp forever-starter.json $HOME/etc/ || exit 22


#
# Init file for the user
#

ln -sf bin/forever-starter $HOME/init || exit 23


#
# nodeos home
#

HOME=$OBJECTS/nodeos

mkdir -p $HOME || exit 30


#
# Install user dependencies
#

CC=$TARGET-gcc                  \
CXX=$TARGET-g++                 \
npm_config_prefix=$HOME         \
$NODE_DIR/deps/npm/cli.js       \
    install -g                  \
    --loglevel warn             \
    --arch=$NODE_ARCH           \
    --nodedir=$NODE_DIR         \
    --jobs=$JOBS                \
    `grep -v "^#" packages_nodeos.txt` || exit 31


#
# Dummy init file for the user
#

cp init.js $HOME/init || exit 32


#
# Copy nodeos user login info
#

mkdir -p $HOME/etc       &&
cp logon.json $HOME/etc/ || exit 33


#
# Wrap the system up and pack it
#

case $PLATFORM in
  docker)
    chmod -R go= "$HOME"    &&
    docker build -t $name . || exit 40
  ;;
  pc_qemu | pc_iso | raspberry_qemu | raspberry_image)
    DISK_SIZE=64  # Size in MB

    mkdir -p `dirname $OUT_DIR`

    genext2fs -b $((DISK_SIZE*1024)) \
        --root $OBJECTS              \
        --bytes-per-inode 8192       \
        --reserved-percentage 0      \
        --squash $OUT_DIR            || exit 41

#    scripts/debugfs.chownr $OUT_DIR 1 nodeos

    ln -sfv $OUT_DIR $name.img || exit 42
  ;;
esac


echo -e "${GRN}Successfully built Layer-3 image '$name'${CLR}"
