#!/usr/bin/env bash

# This script prepares the users filesystem

GRN="\e[32m"
CLR="\e[0m"


BAREBONES=`pwd`/../nodeos-barebones
NODE_DIR=$BAREBONES/deps/node

GENEXT2FS=`pwd`/deps/genext2fs/genext2fs

TOOLCHAIN=$BAREBONES/node_modules/nodeos-cross-toolchain
TOOLS=$TOOLCHAIN/out

source $TOOLCHAIN/scripts/adjustEnvVars.sh || exit $?


if [[ -z "$name" ]]; then name=usersfs; fi


#
# root home
#

OBJ_DIR=$OBJECTS/root

if [[ ! -d $OBJ_DIR ]]; then
  echo -e "${WHT}Generating root user folder${CLR}"

  mkdir -p $OBJ_DIR || exit 10

  (
    #
    # Install system dependencies
    #

    CC=$TARGET-gcc                  \
    CXX=$TARGET-g++                 \
    npm_config_prefix=$OBJ_DIR      \
    $NODE_DIR/deps/npm/cli.js       \
        install -g                  \
        --loglevel warn             \
        --arch=$NODE_ARCH           \
        --nodedir=$NODE_DIR         \
        --jobs=$JOBS                \
        `grep -v "^#" packages_root.txt` || exit 11


    #
    # Services to be started at boot
    #

    mkdir -p $OBJ_DIR/etc                 &&
    cp forever-starter.json $OBJ_DIR/etc/ || exit 12


    #
    # Init file for the user
    #

    ln -sf bin/forever-starter $OBJ_DIR/init || exit 13
  ) || err $?

  echo -e "${GRN}Successfully generated root user folder${CLR}"
fi


#
# nodeos home
#

OBJ_DIR=$OBJECTS/nodeos

if [[ ! -d $OBJ_DIR ]]; then
  echo -e "${WHT}Generating nodeos user folder${CLR}"

  mkdir -p $OBJ_DIR || exit 30

  (
    #
    # Install user dependencies
    #

    CC=$TARGET-gcc                  \
    CXX=$TARGET-g++                 \
    npm_config_prefix=$OBJ_DIR      \
    $NODE_DIR/deps/npm/cli.js       \
        install -g                  \
        --loglevel warn             \
        --arch=$NODE_ARCH           \
        --nodedir=$NODE_DIR         \
        --jobs=$JOBS                \
        `grep -v "^#" packages_nodeos.txt` || exit 31


    #
    # Dummy init file for the user
    #

    cp init.js $OBJ_DIR/init || exit 32


    #
    # Copy nodeos user login info
    #

    mkdir -p $OBJ_DIR/etc       &&
    cp logon.json $OBJ_DIR/etc/ || exit 33
  ) || err $?

  echo -e "${GRN}Successfully generated nodeos user folder${CLR}"
fi


#
# Wrap the system up and pack it
#

case $PLATFORM in
  docker)
    chmod -R go= "$HOME"    &&
    docker build -t $name . || exit 40
  ;;
  pc_qemu | pc_iso | raspberry_qemu | raspberry_image)
    DISK_SIZE=64  # Size in MB

    mkdir -p `dirname $OUT_DIR`

    $GENEXT2FS -b $((DISK_SIZE*1024)) \
        --root $OBJECTS              \
        --bytes-per-inode     4096   \
        --reserved-percentage    0   \
        --allow-holes                \
        --squash $OUT_DIR            || exit 41

    /sbin/tune2fs -j $OUT_DIR || exit 42

#    scripts/debugfs.chownr $OUT_DIR 1 nodeos

    ln -sfv $OUT_DIR $name.img || exit 43
  ;;
esac


echo -e "${GRN}Successfully built Layer-3 image '$name'${CLR}"
