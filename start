#!/usr/bin/env node

var readlinkSync = require('fs').readlinkSync
var spawn        = require('child_process').spawn


var cpu = readlinkSync('usersfs.img').split('/');

var cpu_family;
switch(cpu[cpu.length-1])
{
  case 'armv6':
    cpu_family = 'arm'
  break

  case 'i386':
  case 'i486':
  case 'i586':
  case 'i686':
  case 'i786':
    cpu_family = 'i386'
  break

  case 'nocona':
  case 'x86_64':
    cpu_family = 'x86_64'
  break
}

var append = 'root=/dev/sda'

switch(process.argv[2])
{
  case 'nographic':
    append += ' console=ttyS0'
    args.push('-nographic')
  break

  case 'curses':
    append += ' vga=extended'  // 80x50
    args.push('-curses')
  break

  default:
    append += ' vga=0x318'  // 1024x768x24
}

var command = 'qemu-system-'+cpu_family

var args =
[
  '-enable-kvm',
  '--kernel', '../nodeos-barebones/bzImage',
  '--initrd', '../nodeos-initramfs/initramfs.cpio.gz',
  '-hda',     'usersfs.img',
  '-append',  append
]

spawn(command, args, {stdio: 'inherit'})
.on('error', console.trace.bind(console))
